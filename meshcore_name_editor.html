<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeshCore Name Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e9ecef;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        label {
            display: block;
            margin: 15px 0 5px 0;
            font-weight: bold;
        }
        .info {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß MeshCore Name Editor</h1>
        
        <div class="info">
            <strong>Instructions:</strong><br>
            1. Connect via BLE or USB Serial<br>
            2. Click "Get Current Name" to read<br>
            3. Edit the name (use actual line breaks)<br>
            4. Click "Set New Name" to update
        </div>

        <button id="connectBLE" onclick="connectBLE()">üì° Connect BLE</button>
        <button id="connectUSB" onclick="connectUSB()">üîå Connect USB Serial</button>
        <button id="disconnect" onclick="disconnect()" disabled>‚ùå Disconnect</button>
        
        <div id="status" class="status">Not connected</div>
        
        <label>Current/New Name (use line breaks for multi-line):</label>
        <textarea id="nameInput" placeholder="Enter node name here...&#10;You can use multiple lines"></textarea>
        
        <button id="getName" onclick="getCurrentName()" disabled>üì• Get Current Name</button>
        <button id="setName" onclick="setNewName()" disabled>üì§ Set New Name</button>
        
        <label>Name Preview (with escape codes):</label>
        <textarea id="namePreview" readonly></textarea>
    </div>

    <script>
        let bleDevice = null;
        let bleCharacteristic = null;
        let serialPort = null;
        let reader = null;
        let writer = null;
        let connectionMode = null; // 'BLE' or 'USB'
        
        const BLE_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Write to radio
        const BLE_RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Read from radio
        
        // Protocol constants
        const CMD_APP_START = 1;
        const CMD_SET_ADVERT_NAME = 8;
        const CMD_DEVICE_QUERY = 22;
        const RESP_CODE_OK = 0;
        const RESP_CODE_ERR = 1;
        const RESP_CODE_SELF_INFO = 5;
        const RESP_CODE_DEVICE_INFO = 13;
        
        // Error codes
        const ERR_CODE_UNSUPPORTED_CMD = 1;
        const ERR_CODE_NOT_FOUND = 2;
        
        document.getElementById('nameInput').addEventListener('input', updatePreview);
        
        function updatePreview() {
            const text = document.getElementById('nameInput').value;
            const escaped = text.replace(/\n/g, '\\n').replace(/\r/g, '\\r');
            document.getElementById('namePreview').value = escaped;
        }
        
        async function connectBLE() {
            try {
                setStatus('Requesting BLE device...', 'info');
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLE_SERVICE_UUID] }]
                });
                
                // Handle disconnect events
                bleDevice.addEventListener('gattserverdisconnected', () => {
                    setStatus('BLE disconnected', 'error');
                    disconnect();
                });
                
                setStatus('Connecting to GATT server...', 'info');
                
                // Ensure we're disconnected first
                if (bleDevice.gatt.connected) {
                    await bleDevice.gatt.disconnect();
                }
                
                // Connect with retry
                let server = null;
                for (let attempt = 0; attempt < 3; attempt++) {
                    try {
                        server = await bleDevice.gatt.connect();
                        if (server && server.connected) {
                            break;
                        }
                    } catch (e) {
                        if (attempt === 2) throw e;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                if (!server || !server.connected) {
                    throw new Error('Failed to connect to GATT server');
                }
                
                setStatus('Getting service...', 'info');
                const service = await server.getPrimaryService(BLE_SERVICE_UUID);
                
                setStatus('Getting characteristics...', 'info');
                bleCharacteristic = await service.getCharacteristic(BLE_TX_CHAR_UUID);
                const rxChar = await service.getCharacteristic(BLE_RX_CHAR_UUID);
                
                setStatus('Starting notifications...', 'info');
                await rxChar.startNotifications();
                rxChar.addEventListener('characteristicvaluechanged', handleBLEResponse);
                
                connectionMode = 'BLE';
                onConnected();
                
                // Send app start first (required by protocol)
                await new Promise(resolve => setTimeout(resolve, 500));
                setStatus('Initializing app session...', 'info');
                await sendBLEFrame(new Uint8Array([CMD_APP_START]));
                
                // Then read current name
                await new Promise(resolve => setTimeout(resolve, 500));
                setStatus('Reading current name...', 'info');
                await sendBLEFrame(new Uint8Array([CMD_DEVICE_QUERY]));
                
            } catch (error) {
                setStatus('BLE connection failed: ' + error.message, 'error');
                if (bleDevice && bleDevice.gatt.connected) {
                    await bleDevice.gatt.disconnect();
                }
                bleDevice = null;
                bleCharacteristic = null;
            }
        }
        
        async function connectUSB() {
            try {
                setStatus('Requesting USB serial port...', 'info');
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 115200 });
                
                writer = serialPort.writable.getWriter();
                reader = serialPort.readable.getReader();
                
                connectionMode = 'USB';
                onConnected();
                
                // Start reading responses
                readUSBResponses();
                
                // Send app start first (required by protocol)
                await new Promise(resolve => setTimeout(resolve, 500));
                setStatus('Initializing app session...', 'info');
                await sendUSBFrame(new Uint8Array([CMD_APP_START]));
                
                // Then read current name
                await new Promise(resolve => setTimeout(resolve, 500));
                setStatus('Reading current name...', 'info');
                await sendUSBFrame(new Uint8Array([CMD_DEVICE_QUERY]));
                
            } catch (error) {
                setStatus('USB connection failed: ' + error, 'error');
            }
        }
        
        function onConnected() {
            setStatus('Connected via ' + connectionMode, 'success');
            document.getElementById('connectBLE').disabled = true;
            document.getElementById('connectUSB').disabled = true;
            document.getElementById('disconnect').disabled = false;
            document.getElementById('getName').disabled = false;
            document.getElementById('setName').disabled = false;
        }
        
        async function disconnect() {
            if (connectionMode === 'BLE' && bleDevice) {
                await bleDevice.gatt.disconnect();
                bleDevice = null;
                bleCharacteristic = null;
            } else if (connectionMode === 'USB' && serialPort) {
                if (reader) await reader.cancel();
                if (writer) await writer.close();
                await serialPort.close();
                serialPort = null;
                reader = null;
                writer = null;
            }
            
            connectionMode = null;
            setStatus('Disconnected', 'info');
            document.getElementById('connectBLE').disabled = false;
            document.getElementById('connectUSB').disabled = false;
            document.getElementById('disconnect').disabled = true;
            document.getElementById('getName').disabled = true;
            document.getElementById('setName').disabled = true;
        }
        
        async function sendBLEFrame(data) {
            if (!bleCharacteristic) return;
            await bleCharacteristic.writeValue(data);
        }
        
        async function sendUSBFrame(data) {
            if (!writer) return;
            
            // USB frame: '<' + length (2 bytes LE) + data
            const frame = new Uint8Array(3 + data.length);
            frame[0] = 0x3C; // '<'
            frame[1] = data.length & 0xFF;
            frame[2] = (data.length >> 8) & 0xFF;
            frame.set(data, 3);
            
            await writer.write(frame);
        }
        
        function handleBLEResponse(event) {
            const value = event.target.value;
            const data = new Uint8Array(value.buffer);
            console.log('BLE Response:', Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
            processResponse(data);
        }
        
        async function readUSBResponses() {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    // Parse USB frames: '>' + length (2 bytes LE) + data
                    for (let i = 0; i < value.length; i++) {
                        if (value[i] === 0x3E) { // '>'
                            if (i + 2 < value.length) {
                                const len = value[i+1] | (value[i+2] << 8);
                                if (i + 3 + len <= value.length) {
                                    const frame = value.slice(i + 3, i + 3 + len);
                                    processResponse(frame);
                                    i += 2 + len;
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.message !== 'The reader has been cancelled') {
                    setStatus('USB read error: ' + error, 'error');
                }
            }
        }
        
        function processResponse(data) {
            if (data.length === 0) return;
            
            const code = data[0];
            console.log('Processing response code:', code, 'Length:', data.length);
            
            if (code === RESP_CODE_ERR) {
                const errCode = data.length > 1 ? data[1] : 0;
                const errNames = ['', 'UNSUPPORTED_CMD', 'NOT_FOUND', 'TABLE_FULL', 'BAD_STATE', 'FILE_IO_ERROR', 'ILLEGAL_ARG'];
                const errName = errNames[errCode] || 'UNKNOWN';
                setStatus('‚ùå Error: ' + errName + ' (code ' + errCode + ')', 'error');
                console.log('Error response:', errName);
            } else if (code === RESP_CODE_SELF_INFO) {
                // Self info from CMD_APP_START
                console.log('Self info received:', Array.from(data));
                setStatus('App session initialized', 'info');
            } else if (code === RESP_CODE_DEVICE_INFO) {
                // Device info received: code(1) + adv_type(1) + flags(1) + reserved(2) + name(rest)
                console.log('Device info response! Data:', Array.from(data));
                if (data.length > 5) {
                    const nameBytes = data.slice(5);
                    const name = new TextDecoder().decode(nameBytes);
                    console.log('Decoded name:', name);
                    document.getElementById('nameInput').value = name;
                    updatePreview();
                    
                    // Show current name with visual newline indicator
                    const displayName = name.replace(/\n/g, '\\n');
                    const lineCount = (name.match(/\n/g) || []).length + 1;
                    setStatus('‚úÖ Connected! Current name: "' + displayName + '" (' + lineCount + ' line' + (lineCount > 1 ? 's' : '') + ')', 'success');
                } else {
                    console.log('Device info too short');
                    setStatus('‚úÖ Connected! (Name empty or unavailable)', 'success');
                }
            } else if (code === RESP_CODE_OK) {
                setStatus('‚úÖ Name set successfully!', 'success');
            } else {
                console.log('Unknown response code:', code, 'Full data:', Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
            }
        }
        
        async function getCurrentName() {
            setStatus('Reading current name...', 'info');
            const cmd = new Uint8Array([CMD_DEVICE_QUERY]);
            
            if (connectionMode === 'BLE') {
                await sendBLEFrame(cmd);
            } else if (connectionMode === 'USB') {
                await sendUSBFrame(cmd);
            }
        }
        
        async function setNewName() {
            const newName = document.getElementById('nameInput').value;
            
            if (newName.length === 0) {
                setStatus('Name cannot be empty', 'error');
                return;
            }
            
            if (newName.length > 31) {
                setStatus('Name too long (max 31 bytes)', 'error');
                return;
            }
            
            setStatus('Setting new name...', 'info');
            
            const nameBytes = new TextEncoder().encode(newName);
            const cmd = new Uint8Array(1 + nameBytes.length);
            cmd[0] = CMD_SET_ADVERT_NAME;
            cmd.set(nameBytes, 1);
            
            if (connectionMode === 'BLE') {
                await sendBLEFrame(cmd);
            } else if (connectionMode === 'USB') {
                await sendUSBFrame(cmd);
            }
        }
        
        function setStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status';
            if (type) statusDiv.classList.add(type);
        }
    </script>
</body>
</html>

